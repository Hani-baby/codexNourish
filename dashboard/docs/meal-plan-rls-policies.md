# Meal Plan RLS Policies Documentation

## Overview

This document explains the Row Level Security (RLS) policies implemented for the meal plan related tables to ensure proper access control while maintaining functionality for service operations.

## Tables Covered

### 1. meal_plan_drafts
**Purpose**: Stores draft meal plans generated by AI before they are finalized

**Current State**: RLS was previously disabled to allow service functions to work, but has been re-enabled with secure policies.

**Policies**:
- **View**: Users can view drafts for their household (master user or family members)
- **Create**: Users can create drafts for their household with proper user_id validation
- **Update**: Users can update their own drafts within their household
- **Delete**: Users can delete their own drafts within their household
- **Service Role**: All operations allow service role access (when auth.uid() is null)

### 2. meal_plan_progress
**Purpose**: Tracks progress of meal plan generation and processing

**Previous State**: No RLS policies (security gap)
**Current State**: RLS enabled with user-specific policies

**Policies**:
- **View**: Users can view their own progress entries
- **Create**: Users can create progress entries for themselves
- **Update**: Users can update their own progress entries
- **Delete**: Users can delete their own progress entries
- **Service Role**: All operations allow service role access (when auth.uid() is null)

## Security Considerations

### What These Policies Protect Against

1. **Cross-Household Access**: Users cannot access meal plans or drafts from other households
2. **Unauthorized Progress Tracking**: Users cannot view or modify progress entries for other users
3. **Data Leakage**: Prevents accidental exposure of sensitive meal plan data

### What These Policies Allow

1. **Service Functions**: The mealPlanDraft function can operate with service role permissions
2. **Household Sharing**: Family members can access shared household meal plans
3. **User Operations**: Authenticated users can manage their own data

## Service Role Compatibility

The policies include `auth.uid() IS NULL` conditions to allow service role operations. This is necessary because:

1. **mealPlanDraft Function**: Uses service role to create and update draft records
2. **Background Jobs**: Async job processors need to update progress and drafts
3. **System Operations**: Automated cleanup and maintenance tasks

## Implementation Files

- `supabase/migrations/add_meal_plan_progress_rls_policies.sql` - Adds RLS to meal_plan_progress
- `supabase/migrations/secure_meal_plan_drafts_rls_policies.sql` - Re-enables RLS for meal_plan_drafts with secure policies

## Testing Recommendations

1. **User Access**: Verify users can only access their own household data
2. **Service Functions**: Test that mealPlanDraft function still works correctly
3. **Cross-User Access**: Ensure users cannot access other users' data
4. **Progress Tracking**: Verify progress entries are properly isolated per user

## Migration Order

1. Apply `add_meal_plan_progress_rls_policies.sql` first
2. Apply `secure_meal_plan_drafts_rls_policies.sql` second
3. Test functionality after each migration

## Rollback Plan

If issues arise:
1. `meal_plan_progress`: Drop policies and disable RLS
2. `meal_plan_drafts`: Revert to disabled RLS state using existing `disable_meal_plan_drafts_rls.sql`

## Security Benefits

- **Data Isolation**: Users can only access their own data
- **Household Privacy**: Cross-household data access is prevented
- **Service Compatibility**: Service functions continue to work
- **Audit Trail**: All access is properly logged through RLS
